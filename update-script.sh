#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –æ–Ω–æ–≤–ª–µ–Ω–Ω—è Matrix Synapse —Å–∏—Å—Ç–µ–º–∏

MATRIX_DIR="/DATA/matrix"
BACKUP_SCRIPT="/DATA/matrix-backups/backup-matrix.sh"

echo "üîÑ –ü–æ—á–∞—Ç–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è Matrix Synapse —Å–∏—Å—Ç–µ–º–∏..."

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [[ $EUID -ne 0 ]]; then
   echo "‚ùå –¶–µ–π —Å–∫—Ä–∏–ø—Ç –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç–∏ –∑ –ø—Ä–∞–≤–∞–º–∏ root –∞–±–æ —á–µ—Ä–µ–∑ sudo."
   exit 1
fi

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–µ–∫–∞–ø—É –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º
if [ -f "$BACKUP_SCRIPT" ]; then
    echo "üíæ –°—Ç–≤–æ—Ä—é—é —Ä–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é –ø–µ—Ä–µ–¥ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º..."
    $BACKUP_SCRIPT
    if [ $? -eq 0 ]; then
        echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ"
    else
        echo "‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó"
        read -p "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±–µ–∑ –±–µ–∫–∞–ø—É? (yes/no) [no]: " CONTINUE_WITHOUT_BACKUP
        if [ "$CONTINUE_WITHOUT_BACKUP" != "yes" ]; then
            echo "‚ùå –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ"
            exit 1
        fi
    fi
else
    echo "‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
fi

cd "$MATRIX_DIR"

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –æ–±—Ä–∞–∑—ñ–≤
echo "üì• –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –Ω–æ–≤—ñ Docker –æ–±—Ä–∞–∑–∏..."
if docker compose pull; then
    echo "‚úÖ –û–±—Ä–∞–∑–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±—Ä–∞–∑—ñ–≤"
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤—ñ—Å—ñ–≤
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤—ñ—Å–∏ –∑ –Ω–æ–≤–∏–º–∏ –æ–±—Ä–∞–∑–∞–º–∏..."
if docker compose up -d --remove-orphans; then
    echo "‚úÖ –°–µ—Ä–≤—ñ—Å–∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤—ñ—Å—ñ–≤"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤'—è –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
echo "üè• –ü–µ—Ä–µ–≤—ñ—Ä—è—é –∑–¥–æ—Ä–æ–≤'—è —Å–∏—Å—Ç–µ–º–∏ –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è..."
sleep 30  # –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ —Å–µ—Ä–≤—ñ—Å–∏ –∑–∞–ø—É—Å—Ç—è—Ç—å—Å—è

if curl -sf http://localhost:8008/_matrix/client/versions > /dev/null; then
    echo "‚úÖ Matrix Synapse –ø—Ä–∞—Ü—é—î –∫–æ—Ä–µ–∫—Ç–Ω–æ"
else
    echo "‚ùå Matrix Synapse –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î"
    echo "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏: docker compose logs synapse"
    exit 1
fi

# –û—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö –æ–±—Ä–∞–∑—ñ–≤
echo "üßπ –û—á–∏—â—É—é —Å—Ç–∞—Ä—ñ Docker –æ–±—Ä–∞–∑–∏..."
docker image prune -f

echo "üéâ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
echo "üìä –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏:"
docker compose ps
