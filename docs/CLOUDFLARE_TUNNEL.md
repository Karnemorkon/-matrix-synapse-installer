# üåê Cloudflare Tunnel –¥–ª—è Matrix Synapse

–î–µ—Ç–∞–ª—å–Ω–∏–π –≥—ñ–¥ –ø–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—é Cloudflare Tunnel –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –¥–æ Matrix Synapse —Å–µ—Ä–≤–µ—Ä–∞.

## üéØ –©–æ —Ç–∞–∫–µ Cloudflare Tunnel?

Cloudflare Tunnel - —Ü–µ —Å–µ—Ä–≤—ñ—Å, —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î –±–µ–∑–ø–µ—á–Ω–æ –ø—ñ–¥–∫–ª—é—á–∞—Ç–∏ —Å–µ—Ä–≤—ñ—Å–∏ –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É –±–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ:
- –ü—É–±–ª—ñ—á–Ω–æ–≥–æ IP –∞–¥—Ä–µ—Å–∏
- –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø–æ—Ä—Ç—ñ–≤ —É —Ñ–∞–π—Ä–≤–æ–ª—ñ
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SSL —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤

## ‚úÖ –ü–µ—Ä–µ–≤–∞–≥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

- üîí **–ë–µ–∑–ø–µ–∫–∞** - –≤—Å—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è —à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ
- üõ°Ô∏è **DDoS –∑–∞—Ö–∏—Å—Ç** - –≤–±—É–¥–æ–≤–∞–Ω–∏–π –≤ Cloudflare
- üåç **–ì–ª–æ–±–∞–ª—å–Ω–∞ –º–µ—Ä–µ–∂–∞** - —à–≤–∏–¥–∫–∏–π –¥–æ—Å—Ç—É–ø –∑ –±—É–¥—å-—è–∫–æ—ó —Ç–æ—á–∫–∏ —Å–≤—ñ—Ç—É
- üîß **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –º—ñ–Ω—ñ–º—É–º –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
- üì± **–ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø** - –ø—Ä–∞—Ü—é—î –∑–∞ NAT

## üöÄ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Cloudflare Tunnel

### 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç—É–Ω–Ω–µ–ª—é –≤ Cloudflare Dashboard

1. **–£–≤—ñ–π–¥—ñ—Ç—å –≤ Cloudflare Dashboard**
   - –ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ [dash.cloudflare.com](https://dash.cloudflare.com)
   - –í–∏–±–µ—Ä—ñ—Ç—å –≤–∞—à –¥–æ–º–µ–Ω

2. **–°—Ç–≤–æ—Ä—ñ—Ç—å —Ç—É–Ω–Ω–µ–ª—å**
   - –ü–µ—Ä–µ–π–¥—ñ—Ç—å –≤ —Ä–æ–∑–¥—ñ–ª "Zero Trust" ‚Üí "Access" ‚Üí "Tunnels"
   - –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "Create a tunnel"
   - –í–∏–±–µ—Ä—ñ—Ç—å "Cloudflared"

3. **–ù–∞–ª–∞—à—Ç—É–π—Ç–µ —Ç—É–Ω–Ω–µ–ª—å**
   - –í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç—É–Ω–Ω–µ–ª—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "matrix-synapse")
   - –í–∏–±–µ—Ä—ñ—Ç—å "Save tunnel"

4. **–û—Ç—Ä–∏–º–∞–π—Ç–µ —Ç–æ–∫–µ–Ω**
   - –°–∫–æ–ø—ñ—é–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
   - –í–∏–¥—ñ–ª—ñ—Ç—å —Ç–æ–∫–µ–Ω –∑ –∫–æ–º–∞–Ω–¥–∏ (—á–∞—Å—Ç–∏–Ω–∞ –ø—ñ—Å–ª—è `--token`)

### 2. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Matrix

–ü—ñ–¥ —á–∞—Å –∑–∞–ø—É—Å–∫—É `install.sh`:

```bash
# –ó–∞–ø—É—Å–∫ —ñ–Ω—Å—Ç–∞–ª—è—Ç–æ—Ä–∞
sudo ./install.sh

# –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ Cloudflare Tunnel
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Cloudflare Tunnel –¥–ª—è –¥–æ—Å—Ç—É–ø—É? [y/N]: y

# –í–≤–µ–¥–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—É
–í–≤–µ–¥—ñ—Ç—å —Ç–æ–∫–µ–Ω Cloudflare Tunnel: your-tunnel-token-here
```

### 3. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –≤ Cloudflare

–ü—ñ—Å–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏ –≤ Cloudflare Dashboard:

1. **–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –≤–∞—à–æ–≥–æ —Ç—É–Ω–Ω–µ–ª—é**
   - Zero Trust ‚Üí Access ‚Üí Tunnels ‚Üí –í–∞—à —Ç—É–Ω–Ω–µ–ª—å

2. **–î–æ–¥–∞–π—Ç–µ –ø—É–±–ª—ñ—á–Ω—ñ —Ö–æ—Å—Ç–∏**
   - –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "Configure" ‚Üí "Public Hostnames"
   - –î–æ–¥–∞–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ –º–∞—Ä—à—Ä—É—Ç–∏:

#### Element Web (–æ—Å–Ω–æ–≤–Ω–∏–π –¥–æ–º–µ–Ω)
```
Subdomain: (–∑–∞–ª–∏—à—Ç–µ –ø–æ—Ä–æ–∂–Ω—ñ–º –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–º–µ–Ω—É)
Domain: yourdomain.com
Service: http://localhost:80
```

#### Matrix Synapse API
```
Subdomain: matrix
Domain: yourdomain.com
Service: http://localhost:8008
```

#### Synapse Admin (–ª–æ–∫–∞–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø)
```
Subdomain: admin
Domain: yourdomain.com
Service: http://localhost:8080
```

#### Grafana (–ª–æ–∫–∞–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø)
```
Subdomain: grafana
Domain: yourdomain.com
Service: http://localhost:3000
```

#### Prometheus (–ª–æ–∫–∞–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø)
```
Subdomain: prometheus
Domain: yourdomain.com
Service: http://localhost:9090
```

## üîß –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–±–æ—Ç–∏

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É —Ç—É–Ω–Ω–µ–ª—é
```bash
# –ü–µ—Ä–µ–≥–ª—è–¥ —Å—Ç–∞—Ç—É—Å—É –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
./bin/matrix-control.sh status

# –ü–µ—Ä–µ–≥–ª—è–¥ –ª–æ–≥—ñ–≤ cloudflared
./bin/matrix-control.sh logs cloudflared
```

### –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É
```bash
# –¢–µ—Å—Ç Element Web (–æ—Å–Ω–æ–≤–Ω–∏–π –¥–æ–º–µ–Ω)
curl -I https://yourdomain.com

# –¢–µ—Å—Ç Matrix Synapse API
curl -I https://matrix.yourdomain.com/_matrix/client/versions

# –¢–µ—Å—Ç Synapse Admin (–ª–æ–∫–∞–ª—å–Ω–æ)
curl -I http://localhost:8080

# –¢–µ—Å—Ç Grafana (–ª–æ–∫–∞–ª—å–Ω–æ)
curl -I http://localhost:3000

# –¢–µ—Å—Ç Prometheus (–ª–æ–∫–∞–ª—å–Ω–æ)
curl -I http://localhost:9090
```

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç—É–Ω–Ω–µ–ª–µ–º

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç—É–Ω–Ω–µ–ª—é
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ cloudflared –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
./bin/matrix-control.sh restart cloudflared

# –ê–±–æ —á–µ—Ä–µ–∑ Docker Compose
cd /opt/matrix
docker compose restart cloudflared
```

### –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—É
```bash
# –ó—É–ø–∏–Ω–∫–∞ —Å–µ—Ä–≤—ñ—Å—ñ–≤
./bin/matrix-control.sh stop

# –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è .env —Ñ–∞–π–ª—É
nano /opt/matrix/.env

# –ó–º—ñ–Ω—ñ—Ç—å CLOUDFLARE_TUNNEL_TOKEN –Ω–∞ –Ω–æ–≤–∏–π —Ç–æ–∫–µ–Ω

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤—ñ—Å—ñ–≤
./bin/matrix-control.sh start
```

## üîí –ë–µ–∑–ø–µ–∫–∞

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
1. **–†–µ–≥—É–ª—è—Ä–Ω–æ –æ–Ω–æ–≤–ª—é–π—Ç–µ —Ç–æ–∫–µ–Ω** - –∫–æ–∂–Ω—ñ 90 –¥–Ω—ñ–≤
2. **–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ App Policies** - –æ–±–º–µ–∂—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ —Å–µ—Ä–≤—ñ—Å—ñ–≤
3. **–ú–æ–Ω—ñ—Ç–æ—Ä—Ç–µ –ª–æ–≥–∏** - –ø–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ –ø—ñ–¥–æ–∑—Ä—ñ–ª—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
4. **–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é** - –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤

### App Policies –≤ Cloudflare
```bash
# –°—Ç–≤–æ—Ä—ñ—Ç—å –ø–æ–ª—ñ—Ç–∏–∫—É –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
# Zero Trust ‚Üí Access ‚Üí Applications ‚Üí Add an application

# –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–ª—è Grafana:
# - Domain: grafana.yourdomain.com
# - Policy: Require authentication
# - Identity providers: Email, Google, etc.
```

## üêõ –£—Å—É–Ω–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º

### –¢—É–Ω–Ω–µ–ª—å –Ω–µ –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–æ–∫–µ–Ω
echo $CLOUDFLARE_TUNNEL_TOKEN

# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏
docker compose logs cloudflared

# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Cloudflare
curl -I https://cloudflare.com
```

### –°–µ—Ä–≤—ñ—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ñ —Å–µ—Ä–≤—ñ—Å–∏
curl -I http://localhost:8008/_matrix/client/versions

# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏ –≤ Cloudflare Dashboard
# Zero Trust ‚Üí Access ‚Üí Tunnels ‚Üí –í–∞—à —Ç—É–Ω–Ω–µ–ª—å ‚Üí Public Hostnames
```

### –ü–æ–≤—ñ–ª—å–Ω–µ –∑'—î–¥–Ω–∞–Ω–Ω—è
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≥–µ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è
# Cloudflare –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–±–∏—Ä–∞—î –Ω–∞–π–±–ª–∏–∂—á–∏–π –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä

# –ú–æ–∂–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –≤ Cloudflare Dashboard:
# Speed ‚Üí Optimization ‚Üí Auto Minify
```

## üìö –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ—Å—É—Ä—Å–∏

- [Cloudflare Tunnel –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)
- [Cloudflare Zero Trust](https://developers.cloudflare.com/cloudflare-one/)
- [Matrix.org –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è](https://matrix.org/docs/)
- [Synapse –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è](https://matrix-org.github.io/synapse/)

## üîÑ –ú—ñ–≥—Ä–∞—Ü—ñ—è –∑ —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–æ–≥–æ SSL

–Ø–∫—â–æ —É –≤–∞—Å –≤–∂–µ —î Matrix —Å–µ—Ä–≤–µ—Ä –∑ Let's Encrypt:

1. **–°—Ç–≤–æ—Ä—ñ—Ç—å Cloudflare Tunnel**
2. **–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏**
3. **–¢–µ—Å—Ç—É–π—Ç–µ –¥–æ—Å—Ç—É–ø**
4. **–û–Ω–æ–≤—ñ—Ç—å DNS –∑–∞–ø–∏—Å–∏** (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
5. **–í–∏–º–∫–Ω—ñ—Ç—å Let's Encrypt** –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó

---

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** Cloudflare Tunnel –∑–∞–±–µ–∑–ø–µ—á—É—î –±–µ–∑–ø–µ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –≤–∞—à–æ–≥–æ Matrix —Å–µ—Ä–≤–µ—Ä–∞ –±–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ –ø—É–±–ª—ñ—á–Ω–æ–≥–æ IP –∞–±–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø–æ—Ä—Ç—ñ–≤. 