#!/bin/bash
# ===================================================================================
# Matrix Synapse –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –Ü–Ω—Å—Ç–∞–ª—è—Ç–æ—Ä - –ì–æ–ª–æ–≤–Ω–∞ –¢–æ—á–∫–∞ –í—Ö–æ–¥—É
# –í–µ—Ä—Å—ñ—è: 3.0 –†–µ—Ñ–∞–∫—Ç–æ—Ä–æ–≤–∞–Ω–∞
# ===================================================================================

set -euo pipefail

# --- –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è ---
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_NAME="Matrix Synapse Installer"
readonly PROJECT_VERSION="3.0"

# --- –†–∞–Ω–Ω—î –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –®–ª—è—Ö—ñ–≤ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó ---
# –¶–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –ø–µ—Ä–µ–¥ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º –º–æ–¥—É–ª—ñ–≤ –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —É–∑–≥–æ–¥–∂–µ–Ω–∏—Ö —à–ª—è—Ö—ñ–≤
if [[ -n "${SUDO_USER:-}" ]]; then
    # –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω–æ –∑ sudo, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¥–æ–º–∞—à–Ω—é –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    ACTUAL_USER_HOME=$(getent passwd "${SUDO_USER}" | cut -d: -f6)
    CONFIG_DIR="${ACTUAL_USER_HOME}/.config/matrix-installer"
else
    # –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ —è–∫ root
    CONFIG_DIR="/root/.config/matrix-installer"
fi
readonly CONFIG_FILE="${CONFIG_DIR}/config.conf"

# –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –≤—Å—ñ –º–æ–¥—É–ª—ñ
source "${SCRIPT_DIR}/lib/logger.sh"
source "${SCRIPT_DIR}/lib/config.sh"
source "${SCRIPT_DIR}/lib/validator.sh"
source "${SCRIPT_DIR}/lib/docker.sh"
source "${SCRIPT_DIR}/lib/matrix.sh"
source "${SCRIPT_DIR}/lib/bridges.sh"
source "${SCRIPT_DIR}/lib/monitoring.sh"
source "${SCRIPT_DIR}/lib/backup.sh"
source "${SCRIPT_DIR}/lib/security.sh"

# --- –ì–æ–ª–æ–≤–Ω–∞ –§—É–Ω–∫—Ü—ñ—è ---
main() {
    # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
    init_logger
    
    # –ü–æ–∫–∞–∑—É—î–º–æ –±–∞–Ω–µ—Ä
    show_banner
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–µ—Ä–µ–¥—É–º–æ–≤–∏
    check_root_privileges
    validate_system_requirements
    
    # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∞–±–æ —Å—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
    if [[ -f "${CONFIG_FILE}" ]]; then
        log_info "–ó–Ω–∞–π–¥–µ–Ω–æ —ñ—Å–Ω—É—é—á—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é: ${CONFIG_FILE}"
        
        USE_EXISTING_CONFIG=$(ask_yes_no "–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ñ—Å–Ω—É—é—á—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é?" "false")
        if [[ "${USE_EXISTING_CONFIG}" == "true" ]]; then
            log_info "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é —ñ—Å–Ω—É—é—á—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é"
            load_config
        else
            log_info "–°—Ç–≤–æ—Ä—é—é –Ω–æ–≤—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é"
            interactive_config
        fi
    else
        log_info "–°—Ç–≤–æ—Ä—é—é –Ω–æ–≤—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é"
        interactive_config
    fi
    
    # –í–∞–ª—ñ–¥—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
    validate_config
    
    # –ü–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥—Å—É–º–æ–∫ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
    show_config_summary
    
    CONTINUE_INSTALL=$(ask_yes_no "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è?" "false")
    if [[ "${CONTINUE_INSTALL}" != "true" ]]; then
        log_info "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º"
        exit 0
    fi
    
    # –í–∏–∫–æ–Ω—É—î–º–æ –∫—Ä–æ–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
    execute_installation
    
    # –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
    show_completion_message
}

# --- –î–æ–ø–æ–º—ñ–∂–Ω—ñ –§—É–Ω–∫—Ü—ñ—ó ---
show_banner() {
    cat << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                              ‚ïë
‚ïë                    üöÄ Matrix Synapse Auto Installer 3.0                     ‚ïë
‚ïë                                                                              ‚ïë
‚ïë    –ê–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Matrix Synapse –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é –º–æ—Å—Ç—ñ–≤,          ‚ïë
‚ïë                    –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É —Ç–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è                      ‚ïë
‚ïë                                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
    echo
}

execute_installation() {
    log_info "–ü–æ—á–∞—Ç–æ–∫ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Matrix Synapse"
    
    # –ö—Ä–æ–∫ 1: –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
    log_step "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π"
    install_docker_dependencies
    
    # –ö—Ä–æ–∫ 2: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π
    log_step "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π"
    setup_directory_structure
    
    # –ö—Ä–æ–∫ 3: –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π
    log_step "–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤"
    generate_synapse_config
    
    # –ì–µ–Ω–µ—Ä—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é Element —è–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ
    if [[ "${INSTALL_ELEMENT}" == "true" ]]; then
        generate_element_config
    fi
    
    if [[ "${INSTALL_BRIDGES}" == "true" ]]; then
        generate_bridge_configs
    fi
    
    # –ö—Ä–æ–∫ 4: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏
    log_step "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏"
    setup_security
    
    # –ö—Ä–æ–∫ 5: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É
    if [[ "${SETUP_MONITORING}" == "true" ]]; then
        log_step "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É"
        setup_monitoring_stack
    fi
    
    # –ö—Ä–æ–∫ 6: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è
    if [[ "${SETUP_BACKUP}" == "true" ]]; then
        log_step "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è"
        setup_backup_system
    fi
    
    # –ö—Ä–æ–∫ 7: –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è Docker Compose
    log_step "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è Docker Compose –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó"
    generate_docker_compose
    
    # –ö—Ä–æ–∫ 8: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤—ñ—Å—ñ–≤
    log_step "–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤—ñ—Å—ñ–≤"
    start_matrix_services
    
    # –ö—Ä–æ–∫ 9: –ü–æ—Å—Ç-—ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ–π–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
    log_step "–ü–æ—Å—Ç-—ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ–π–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"
    post_installation_setup
    
    log_success "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
}

show_completion_message() {
    cat << EOF

üéâ –í–°–¢–ê–ù–û–í–õ–ï–ù–ù–Ø –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–Ü–®–ù–û!

üìã –Ü–ù–§–û–†–ú–ê–¶–Ü–Ø –ü–†–û –°–ò–°–¢–ï–ú–£:
   –î–æ–º–µ–Ω: ${DOMAIN}
   –ë–∞–∑–æ–≤–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è: ${BASE_DIR}
   –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª: ${CONFIG_FILE}

üîó –î–û–°–¢–£–ü –î–û –°–ï–†–í–Ü–°–Ü–í:
$(get_service_urls)

üõ†Ô∏è –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –°–ò–°–¢–ï–ú–û–Æ:
   ${BASE_DIR}/bin/matrix-control.sh status
   ${BASE_DIR}/bin/matrix-control.sh logs
   ${BASE_DIR}/bin/matrix-control.sh backup

üìö –î–û–ö–£–ú–ï–ù–¢–ê–¶–Ü–Ø:
   ${BASE_DIR}/docs/README.md

üë§ –°–¢–í–û–†–ï–ù–ù–Ø –ü–ï–†–®–û–ì–û –ö–û–†–ò–°–¢–£–í–ê–ß–ê:
   cd ${BASE_DIR}
   ./bin/matrix-control.sh user create admin

‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è!
EOF
}

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω–æ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
